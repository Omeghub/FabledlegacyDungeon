return function(AutoFarmRef, AutoSpellRef)

    -- =========================
    -- SERVICES
    local Players = game:GetService("Players")
    local RunService = game:GetService("RunService")
    local ReplicatedStorage = game:GetService("ReplicatedStorage")
    local Workspace = game:GetService("Workspace")

    local LocalPlayer = Players.LocalPlayer
    local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

    -- =========================
    -- CONFIG
    local ATTACK_MIN_DISTANCE = 4
    local ATTACK_MAX_DISTANCE = 15
    local MOVE_MIN_DISTANCE = 4
    local BACK_STEP = 3

    local MOVE_REFRESH = 0.25
    local CHECKPOINT_REACH = 5
    local NEARBY_MOB_RADIUS = 60

    local AttackDelay = 1
    local SpellDelay = 0.4

    -- =========================
    -- CHECKPOINTS
    local checkpoints = {
        Vector3.new(1653.438,6.109,-612.607),
        Vector3.new(1722.797,6.109,-484.297),
        Vector3.new(1683.689,6.116,-386.110),
        Vector3.new(1564.048,31.389,-324.188),
        Vector3.new(1593.990,31.389,-266.048),

        -- ROOM 4 (NE PAS SUPPRIMER AVANT 5/7)
        Vector3.new(1489.746,62.712,-217.690),
        Vector3.new(1413.490,62.712,-181.697),
        Vector3.new(1458.985,62.712,-85.676),
        Vector3.new(1490.300,62.712,-70.339),
        Vector3.new(1562.556,62.712,-59.482),

        Vector3.new(1650.999,60.516,-36.131),
        Vector3.new(1701.859,60.516,-27.420),
        Vector3.new(1764.283,60.516,92.626),
        Vector3.new(1783.922,60.516,135.935),
        Vector3.new(1778.290,61.508,173.216),
        Vector3.new(1768.041,71.015,222.259),
        Vector3.new(1739.042,81.188,267.057)
    }

    local CurrentCheckpointIndex = 1

    local ROOM4_START = 6
    local ROOM4_END = 10

    -- =========================
    -- STATE
    local Character, HRP, Humanoid
    local LastMoveTime = 0
    local LastSwingTime = 0
    local LastCheckpointTime = 0

    local CHECKPOINT_COOLDOWN = 1

    -- =========================
    -- UTILS
    local function GetRoot(model)
        if model.PrimaryPart then return model.PrimaryPart end
        for _, v in ipairs(model:GetDescendants()) do
            if v:IsA("BasePart") then
                return v
            end
        end
        return nil
    end

    local function GetCurrentRoom()
        local gui = PlayerGui:FindFirstChild("TopbarStandard")
        if not gui then return nil end
        for _, v in ipairs(gui:GetDescendants()) do
            if v:IsA("TextLabel") then
                local r = string.match(v.Text, "(%d+)/%d+")
                if r then return tonumber(r) end
            end
        end
        return nil
    end

    local function IsMobAlive(name)
        local enemies = Workspace:FindFirstChild("Enemies")
        if not enemies then return false end
        local mob = enemies:FindFirstChild(name)
        if mob then
            local hum = mob:FindFirstChildOfClass("Humanoid")
            return hum and hum.Health > 0
        end
        return false
    end

    local function GetBossTarget()
        local enemies = Workspace:FindFirstChild("Enemies")
        if not enemies then return nil end

        for _, bossName in ipairs({
            "Beastmaster Joe & Abbadon",
            "The Beast King",
            "Cursed Centaur"
        }) do
            if IsMobAlive(bossName) then
                print("ðŸŽ¯ Boss dÃ©tectÃ© :", bossName)
                return GetRoot(enemies[bossName])
            end
        end
        return nil
    end

    local function GetNearestMob()
        local enemies = Workspace:FindFirstChild("Enemies")
        if not enemies then return nil end

        local closest, dist = nil, math.huge
        for _, mob in ipairs(enemies:GetChildren()) do
            if mob:IsA("Model") then
                local hum = mob:FindFirstChildOfClass("Humanoid")
                local root = GetRoot(mob)
                if hum and root and hum.Health > 0 then
                    local d = (root.Position - HRP.Position).Magnitude
                    if d < dist and d <= NEARBY_MOB_RADIUS then
                        dist = d
                        closest = root
                    end
                end
            end
        end
        return closest
    end

    local function SetupCharacter(char)
        Character = char
        HRP = char:WaitForChild("HumanoidRootPart")
        Humanoid = char:WaitForChild("Humanoid")
        Humanoid.AutoRotate = true
    end

    if LocalPlayer.Character then
        SetupCharacter(LocalPlayer.Character)
    end

    LocalPlayer.CharacterAdded:Connect(function(char)
        task.wait(1)
        SetupCharacter(char)
    end)

    -- =========================
    -- MAIN LOOP
    RunService.Heartbeat:Connect(function()
        if not AutoFarmRef.Value then return end
        if not HRP or not Humanoid or Humanoid.Health <= 0 then return end
        if tick() - LastMoveTime < MOVE_REFRESH then return end
        LastMoveTime = tick()

        local myPos = HRP.Position
        local moveTarget = nil

        local bossTarget = GetBossTarget()
        local mobTarget = GetNearestMob()
        local target = bossTarget or mobTarget

        -- =========================
        -- CHECKPOINT LOGIC
        local room = GetCurrentRoom()
        if checkpoints[CurrentCheckpointIndex]
        and tick() - LastCheckpointTime > CHECKPOINT_COOLDOWN then

            local cp = checkpoints[CurrentCheckpointIndex]
            if (Vector3.new(cp.X,0,cp.Z) - Vector3.new(myPos.X,0,myPos.Z)).Magnitude <= CHECKPOINT_REACH then
                if not (room == 4 and CurrentCheckpointIndex >= ROOM4_START and CurrentCheckpointIndex <= ROOM4_END) then
                    CurrentCheckpointIndex += 1
                    LastCheckpointTime = tick()
                    print("âž¡ï¸ Checkpoint avancÃ© :", CurrentCheckpointIndex)
                else
                    print("â›” Checkpoint room 4 bloquÃ© (pas 5/7)")
                end
            end
        end

        -- =========================
        -- COMBAT
        if target then
            local mobPos = target.Position
            local dir = (mobPos - myPos)
            local dist = math.max(dir.Magnitude, 0.1)
            dir = dir.Unit

            HRP.CFrame = CFrame.lookAt(myPos, Vector3.new(mobPos.X, myPos.Y, mobPos.Z))

            if dist > ATTACK_MIN_DISTANCE then
                moveTarget = mobPos - dir * ATTACK_MIN_DISTANCE
            elseif dist < MOVE_MIN_DISTANCE then
                moveTarget = myPos - dir * BACK_STEP
            end

            if dist <= ATTACK_MAX_DISTANCE and tick() - LastSwingTime >= AttackDelay then
                ReplicatedStorage.Swing:FireServer()
                LastSwingTime = tick()
            end
        end

        -- =========================
        -- CHECKPOINT MOVE (SI PAS DE BOSS)
        if not bossTarget and checkpoints[CurrentCheckpointIndex] then
            moveTarget = checkpoints[CurrentCheckpointIndex]
        end

        -- =========================
        -- MOVE
        if moveTarget then
            Humanoid:MoveTo(Vector3.new(moveTarget.X, myPos.Y, moveTarget.Z))
        end
    end)
end
